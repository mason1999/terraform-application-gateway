# Terraform Azure Application Gateway

Table of Contents:
<a id="Terraform_Azure_Application_Gateway"></a>

- [Terraform Azure Application Gateway](#Terraform_Azure_Application_Gateway)
  - [Overview](#Overview)
  - [Prerequisites](#Prerequisites)
  - [Features](#Features)
  - [Limitations](#Limitations)
  - [Documentation](#Documentation)
- [Providers](#Providers)
- [Resources](#Resources)
- [Inputs](#Inputs)
- [Examples](#Examples)
  - [Example -- Simple Redirect](#Example_--_Simple_Redirect)
- [Outputs](#Outputs)
- [Appendix](#Appendix)

<!-- BEGIN_TF_DOCS -->

## Overview

<a id="Overview"></a>

Azure Application Gateway is a layer 7 (OSI) load balancer which allows you to route incoming web traffic to different backend web applications. At it's highest level, the Application Gateway operates at layer 7. This means that it can route the incoming traffic based off `HTTP(S)` requests. This means that it can route incoming traffic to a suitable backend application based off things like domain name (i.e `app1.contoso.com` and `app2.contoso.com`) or url path (i.e `app1.contoso.com/api/getresource`).

## Prerequisites

<a id="Prerequisites"></a>

For SSL/TLS termination or end to end SSL/TLS the following are required:

- Azure Key Vault
- A managed identity with `Key Vault Certificate User` RBAC role over the key vault.

## Features

<a id="Features"></a>

- SSL/TLS Termination <br>
- End to End Encryption <br>
- Autosclaing <br>
- Zone Redundancy <br>
- Static VIP <br>
- URL- based routing <br>
- Multiple-site hosting <br>
- Redirection <br>
- Session affinity <br>
- Connection draining <br>
- Custom error pages <br>
- Rewrite HTTP headers and URL <br>
- Sizing

## Limitations

<a id="Limitations"></a>

- WAF not supported

## Documentation

<a id="Documentation"></a>

- To see a list of the features: https://learn.microsoft.com/en-us/azure/application-gateway/features
- Do not use v1 sku: https://learn.microsoft.com/en-us/azure/application-gateway/v1-retirement
- Subnet size of Application Gateway subnet: https://learn.microsoft.com/en-us/azure/application-gateway/configuration-infrastructure#size-of-the-subnet
- Network Security Groups required for Application Gateway: https://learn.microsoft.com/en-us/azure/application-gateway/configuration-infrastructure#network-security-groups
- Hosting subdomains (or multiple sites) with the same Application Gateway: https://learn.microsoft.com/en-us/azure/application-gateway/multiple-site-overview and https://learn.microsoft.com/en-us/azure/application-gateway/tutorial-multiple-sites-cli

# Providers

<a id="Providers"></a>

| Name                                                         | Version |
| ------------------------------------------------------------ | ------- |
| <a name="provider_azurerm"></a> [azurerm](#provider_azurerm) | =3.88.0 |

# Resources

<a id="Resources"></a>

| Name                                                                                                                                          | Type     |
| --------------------------------------------------------------------------------------------------------------------------------------------- | -------- |
| [azurerm_application_gateway.this](https://registry.terraform.io/providers/hashicorp/azurerm/3.88.0/docs/resources/application_gateway)       | resource |
| [azurerm_public_ip.this](https://registry.terraform.io/providers/hashicorp/azurerm/3.88.0/docs/resources/public_ip)                           | resource |
| [azurerm_role_assignment.this](https://registry.terraform.io/providers/hashicorp/azurerm/3.88.0/docs/resources/role_assignment)               | resource |
| [azurerm_user_assigned_identity.this](https://registry.terraform.io/providers/hashicorp/azurerm/3.88.0/docs/resources/user_assigned_identity) | resource |

# Inputs

<a id="Inputs"></a>

| Name                                                                                                                        | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Type                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | Default | Required |
| --------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------- | :------: |
| <a name="input_backend_address_pools"></a> [backend_address_pools](#input_backend_address_pools)                            | (Required) One or more backend_address_pool blocks as defined below:<br><br> name - (Required) The name of the Backend Address Pool.<br> fqdns - (Optional) A list of FQDN's which should be part of the Backend Address Pool.<br> ip_addresses - (Optional) A list of IP Addresses which should be part of the Backend Address Pool.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | <pre>map(object({<br> name = string<br> fqdns = optional(list(string), null)<br> ip_addresses = optional(list(string), null)<br> }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | n/a     |   yes    |
| <a name="input_backend_http_settings"></a> [backend_http_settings](#input_backend_http_settings)                            | (Required) One or more backend_http_settings blocks as defined below:<br><br> name - (Required) The name of the Backend HTTP Settings Collection.<br> port - (Required) The port which should be used for this Backend HTTP Settings Collection.<br> protocol - (Required) The Protocol which should be used. Possible values are Http and Https.<br><br> cookie_based_affinity - (Optional) Is Cookie-Based Affinity enabled? Possible values are Enabled and Disabled. Defaults to Disabled.<br> probe_name - (Optional) The name of an associated HTTP Probe.<br> affinity_cookie_name - (Optional) The name of the affinity cookie.<br> path - (Optional) The Path which should be used as a prefix for all HTTP requests.<br> request_timeout - (Optional) The request timeout in seconds, which must be between 1 and 86400 seconds. Defaults to 30.<br> host_name - (Optional) Host header to be sent to the backend servers. Cannot be set if pick_host_name_from_backend_address is set to true.<br> pick_host_name_from_backend_address - (Optional) Whether host header should be picked from the host name of the backend server. Defaults to false.<br> trusted_root_certificate_names - (Optional) A list of trusted_root_certificate names.<br> connection_draining - (Optional) A connection_draining block as defined below.<br><br> A connection_draining block supports the following.<br> enabled - (Required) If connection draining is enabled or not.<br> drain_timeout_sec - (Required) The number of seconds connection draining is active. Acceptable values are from 1 second to 3600 seconds.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | <pre>map(object({<br> name = string<br> cookie_based_affinity = optional(string, "Disabled")<br> port = number<br> protocol = string<br> probe_name = optional(string, null)<br> affinity_cookie_name = optional(string, null)<br> path = optional(string, null)<br> request_timeout = optional(number, null)<br> host_name = optional(string, null)<br> pick_host_name_from_backend_address = optional(bool, false)<br> trusted_root_certificate_names = optional(list(string), null)<br> connection_draining = optional(object({<br> enabled = bool<br> drain_timeout_sec = number<br> }), null)<br> }))</pre>                                                                                                                                                                              | n/a     |   yes    |
| <a name="input_frontend_ports"></a> [frontend_ports](#input_frontend_ports)                                                 | (Required) One or more frontend_port blocks as defined below:<br><br> name - (Required) The name of the Frontend Port.<br> port - (Required) The port used for this Frontend Port.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | <pre>map(object({<br> name = string<br> port = number<br> }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | n/a     |   yes    |
| <a name="input_http_listeners"></a> [http_listeners](#input_http_listeners)                                                 | (Required) One or more http_listener blocks as defined below:<br><br> name - (Required) The Name of the HTTP Listener.<br> frontend_configuration_name - (Required) The Name of the Frontend IP Configuration used for this HTTP Listener.<br> frontend_port_name - (Required) The Name of the Frontend Port use for this HTTP Listener.<br> protocol - (Required) The Protocol to use for this HTTP Listener. Possible values are Http and Https.<br> host_name - (Optional) The Hostname which should be used for this HTTP Listener. Setting this value changes Listener Type to 'Multi site'. If host_name is set host_names cannot be set.<br> host_names - (Optional) A list of Hostname(s) should be used for this HTTP Listener. It allows special wildcard characters. If host_names is set host_name cannot be set<br> ssl_certificate_name - (Optional) The name of the associated SSL Certificate which should be used for this HTTP Listener.<br> ssl_profile_name - (Optional) The name of the associated SSL Profile which should be used for this HTTP Listener.<br> custom_error_configurations - (Optional) One or more custom_error_configuration blocks as defined below.<br><br> A custom_error_configuration block supports the following:<br> status_code - (Required) Status code of the application gateway customer error. Possible values are HttpStatus403 and HttpStatus502<br> custom_error_page_url - (Required) Error page URL of the application gateway customer error.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | <pre>map(object({<br> name = string<br> frontend_configuration_name = string<br> frontend_port_name = string<br> protocol = string<br> host_name = optional(string, null)<br> host_names = optional(list(string), null)<br> ssl_certificate_name = optional(string, null)<br> ssl_profile_name = optional(string, null)<br> custom_error_configurations = optional(map(object({<br> status_code = string<br> custom_error_page_url = string<br> })), null)<br> }))</pre>                                                                                                                                                                                                                                                                                                                      | n/a     |   yes    |
| <a name="input_location"></a> [location](#input_location)                                                                   | (Required) The Azure region where the Application Gateway should exist. Changing this forces a new resource to be created.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | n/a     |   yes    |
| <a name="input_name"></a> [name](#input_name)                                                                               | (Required) The name of the Application Gateway. Changing this forces a new resource to be created.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | n/a     |   yes    |
| <a name="input_public_ip_configuration"></a> [public_ip_configuration](#input_public_ip_configuration)                      | (Required) Configuration for public ip resource. public_ip_configuration block is defined below:<br><br> name - (Required) Specifies the name of the Public IP. Changing this forces a new Public IP to be created.<br> frontend_configuration_name - (Required) The name of the public frontend ip connfiguration.<br> ip_version - (Optional) One of the values [IPv4, IPv6]. Defaults to IPv4.<br> domain_name_label - (Optional) Label for the domain name. Will be used to make up the FQDN. If a domain name label is specified, an A DNS record is created for the public IP in the Microsoft Azure DNS sytem. Defaults to null.<br> zones - (Optional) A collection containing the availability zone to allocate the Public IP in. Changing this creates a new public IP resource. Defaults to [].<br> ddos_protection_mode - (Optional) The DDoS protection mode of the public IP. Possible values are Disabled, Enabled, and VirtualNetworkInherited. Defaults to VirtualNetworkInherited.<br> ddos_protection_plan_id - (Optional) The ID of DDoS protection plan associated with the public IP. public_ip_ddos_protection_plan_id can only be set when public_ip_ddos_protection_mode is 'Enabled'.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | <pre>object({<br> public_ip_name = string<br> frontend_configuration_name = string<br> ip_version = optional(string, "IPv4")<br> domain_name_label = optional(string, null)<br> zones = optional(list(string), [])<br> ddos_protection_mode = optional(string, null)<br> ddos_protection_plan_id = optional(string, null)<br> })</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                        | n/a     |   yes    |
| <a name="input_request_routing_rules"></a> [request_routing_rules](#input_request_routing_rules)                            | (Required) One or more request_routing_rule blocks as defined below:<br><br> name - (Required) The Name of this Request Routing Rule.<br> rule_type - (Required) The Type of Routing that should be used for this Rule. Possible values are Basic and PathBasedRouting.<br> priority - (Required) Rule evaluation order can be dictated by specifying an integer value from 1 to 20000 with 1 being the highest priority and 20000 being the lowest priority.<br> http_listener_name - (Required) The Name of the HTTP Listener which should be used for this Routing Rule.<br> backend_http_settings_name - (Optional) The Name of the Backend HTTP Settings Collection which should be used for this Routing Rule. Cannot be set if redirect_configuration_name is set. <br> backend_address_pool_name - (Optional) The Name of the Backend Address Pool which should be used for this Routing Rule. Cannot be set if redirect_configuration_name is set.<br> redirect_configuration_name - (Optional) The Name of the Redirect Configuration which should be used for this Routing Rule. Cannot be set if either backend_address_pool_name or backend_http_settings_name is set.<br> url_path_map_name - (Optional) The Name of the URL Path Map which should be associated with this Routing Rule.<br><br> Note: backend_address_pool_name, backend_http_settings_name, redirect_configuration_name [AND 1 MORE TBD] are only applicable when rule_type is basic.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | <pre>map(object({<br> name = string<br> rule_type = string<br> priority = number<br> http_listener_name = string<br> backend_http_settings_name = optional(string, null)<br> backend_address_pool_name = optional(string, null)<br> redirect_configuration_name = optional(string, null)<br> url_path_map_name = optional(string, null)<br> }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                         | n/a     |   yes    |
| <a name="input_resource_group_name"></a> [resource_group_name](#input_resource_group_name)                                  | (Required) The name of the resource group in which to the Application Gateway should exist. Changing this forces a new resource to be created.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | n/a     |   yes    |
| <a name="input_subnet_id"></a> [subnet_id](#input_subnet_id)                                                                | (Required) The id of the subnet where the Application Gateway should be associated to.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | `string`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | n/a     |   yes    |
| <a name="input_autoscale_configuration"></a> [autoscale_configuration](#input_autoscale_configuration)                      | (Optional) The auto-scaled capacity of the SKU to use for this Application Gateway. An autoscale_configuration block is defined below:<br><br> min_capacity - (Required) Minimum capacity for autoscaling. Accepted values are in the range 0 to 100.<br> max_capacity - (Optional) Maximum capacity for autoscaling. Accepted values are in the range 2 to 125.<br><br> Note: This parameter cannot be used with sku_capacity. They are mutually exclusive.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | <pre>object({<br> min_capacity = optional(number, null)<br> max_capacity = optional(number, null)<br> })</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | `{}`    |    no    |
| <a name="input_custom_error_configurations"></a> [custom_error_configurations](#input_custom_error_configurations)          | (Optional) One or more custom error configuration blocks. A custom_error_configuration block supports the following:<br><br> status_code - (Required) Status code of the application gateway customer error. Possible values are HttpStatus403 and HttpStatus502<br> custom_error_page_url - (Required) Error page URL of the application gateway customer error.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | <pre>map(object({<br> status_code = string<br> custom_error_page_url = string<br> }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | `null`  |    no    |
| <a name="input_private_ip_configurations"></a> [private_ip_configurations](#input_private_ip_configurations)                | (Optional) private_ip_configurations block for private networking as defined below:<br><br> frontend_configuration_name - (Required) The name of the public frontend ip configuration.<br> subnet_id - (Required) The ID of the subnet for the private configuration.<br> private_ip_address_allocation - (Optional) The Allocation Method for the Private IP Address. Possible values are Dynamic and Static. Defaults to Dynamic.<br> private_ip_address - (Optional) The Private IP Address to use for the Application Gateway.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | <pre>map(object({<br> frontend_configuration_name = string<br> subnet_id = string<br> private_ip_address_allocation = optional(string, null)<br> private_ip_address = optional(string, null)<br> }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `{}`    |    no    |
| <a name="input_probes"></a> [probes](#input_probes)                                                                         | (Optional) One or more probe blocks as defined below.<br><br> name - (Required) The Name of the Probe.<br> protocol - (Required) The Protocol used for this Probe. Possible values are Http and Https.<br> path - (Required) The Path used for this Probe.<br> interval - (Required) The Interval between two consecutive probes in seconds. Possible values range from 1 second to a maximum of 86,400 seconds.<br> timeout - (Required) The Timeout used for this Probe, which indicates when a probe becomes unhealthy. Possible values range from 1 second to a maximum of 86,400 seconds.<br> unhealthy_threshold - (Required) The Unhealthy Threshold for this Probe, which indicates the amount of retries which should be attempted before a node is deemed unhealthy. Possible values are from 1 to 20.<br> host - (Optional) The Hostname used for this Probe. If the Application Gateway is configured for a single site, by default the Host name should be specified as 127.0.0.1, unless otherwise configured in custom probe. Cannot be set if pick_host_name_from_backend_http_settings is set to true.<br> port - (Optional) Custom port which will be used for probing the backend servers. The valid value ranges from 1 to 65535. In case not set, port from HTTP settings will be used. This property is valid for Standard_v2 and WAF_v2 only.<br> pick_host_name_from_backend_http_settings - (Optional) Whether the host header should be picked from the backend HTTP settings. Defaults to false.<br> minimum_servers - (Optional) The minimum number of servers that are always marked as healthy. Defaults to 0.<br> match - (Optional) A match block as defined below.<br><br> A match block consists of the following properties:<br><br> status_code - (Required) A list of allowed status codes for this Health Probe. Default range of healthy status codes is 200-399.<br> body - (Optional) A snippet from the Response Body which must be present in the Response.                                                                                                                                                                                                                                                                                                                             | <pre>map(object({<br> name = string<br> protocol = string<br> path = string<br> interval = number<br> timeout = number<br> unhealthy_threshold = number<br> host = optional(string, null)<br> port = optional(number, null)<br> pick_host_name_from_backend_http_settings = optional(bool, false)<br> minimum_servers = optional(number, 0)<br> match = optional(object({<br> status_code = list(string)<br> body = optional(string, null)<br> }), null)<br> }))</pre>                                                                                                                                                                                                                                                                                                                        | `{}`    |    no    |
| <a name="input_redirect_configurations"></a> [redirect_configurations](#input_redirect_configurations)                      | (Optional) One or more redirect_configurations blocks as defined below.<br><br> name - (Required) Unique name of the redirect configuration block<br> redirect_type - (Required) The type of redirect. Possible values are Permanent, Temporary, Found and SeeOther<br> target_url - (Optional) The URL to redirect the request to. Cannot be set if target_listener_name is set.<br> include_path - (Optional) Whether to include the path in the redirected URL. Defaults to false<br> include_query_string - (Optional) Whether to include the query string in the redirected URL. Default to false<br> target_listener_name - (Optional) The name of the listener to redirect to. Cannot be set if target_url is set.<br><br> Note: This is to be referenced by name in the request_routing_rule blocks.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | <pre>map(object({<br> name = string<br> redirect_type = string<br> target_url = optional(string, null)<br> include_path = optional(bool, false)<br> include_query_string = optional(bool, false)<br> target_listener_name = optional(string, null)<br> }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | `{}`    |    no    |
| <a name="input_rewrite_rule_sets"></a> [rewrite_rule_sets](#input_rewrite_rule_sets)                                        | (Optional) One or more of the following rewrite_rule_set blocks. A rewrite_rule_set block supports the following:<br><br> name - (Required) Unique name of the rewrite rule set block<br> rewrite_rules - (Optional) One or more rewrite_rule blocks as defined below.<br><br> name - (Required) Unique name of the rewrite rule block<br> rule_sequence - (Required) Rule sequence of the rewrite rule that determines the order of execution in a set.<br> conditions - (Optional) One or more condition blocks as defined below.<br> request_header_configurations - (Optional) One or more request_header_configuration blocks as defined below.<br> response_header_configurations - (Optional) One or more response_header_configuration blocks as defined below.<br> url - (Optional) One url block as defined below. <br><br> A condition block supports the following:<br> variable - (Required) The variable of the condition.<br> pattern - (Required) The pattern, either fixed string or regular expression, that evaluates the truthfulness of the condition.<br> ignore_case - (Optional) Perform a case in-sensitive comparison. Defaults to false<br> negate - (Optional) Negate the result of the condition evaluation. Defaults to false<br><br> A request_header_configuration block supports the following:<br> header_name - (Required) Header name of the header configuration.<br> header_value - (Required) Header value of the header configuration. To delete a request header set this property to an empty string.<br><br> A response_header_configuration block supports the following:<br> header_name - (Required) Header name of the header configuration.<br> header_value - (Required) Header value of the header configuration. To delete a response header set this property to an empty string.<br><br> A url block supports the following:<br> path - (Optional) The URL path to rewrite.<br> query_string - (Optional) The query string to rewrite.<br> components - (Optional) The components used to rewrite the URL. Possible values are path_only and query_string_only to limit the rewrite to the URL Path or URL Query String only.<br> reroute - (Optional) Whether the URL path map should be reevaluated after this rewrite has been applied. More info on rewrite configuration | <pre>map(object({<br> name = string<br> rewrite_rules = optional(map(object({<br> name = string<br> rule_sequence = number<br> conditions = optional(map(object({<br> variable = string<br> pattern = string<br> ignore_case = optional(bool, false)<br> negate = optional(bool, false)<br> })), null)<br> request_header_configurations = optional(map(object({<br> header_name = string<br> header_value = string<br> })), null)<br> response_header_configurations = optional(map(object({<br> header_name = string<br> header_value = string<br> })), null)<br> url = optional(object({<br> path = optional(string, null)<br> query_string = optional(string, null)<br> components = optional(string, null)<br> reroute = optional(bool, null)<br> }), null)<br> })), null)<br> }))</pre> | `{}`    |    no    |
| <a name="input_sku_capacity"></a> [sku_capacity](#input_sku_capacity)                                                       | (Optional) The Capacity of the SKU to use for this Application Gateway. This value must be between 1 to 125. Required if autoscale_configuration block isn't configured.<br><br> Note: This parameter cannot be used with autoscale_configuration. They are mutually exclusive.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | `number`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | `null`  |    no    |
| <a name="input_ssl_certificates"></a> [ssl_certificates](#input_ssl_certificates)                                           | (Optional) One or more http_listener blocks as defined below. Required if you want to use HTTPS on your listeners.<br><br> name - (Required) The Name of the SSL certificate that is unique within this Application Gateway<br> key_vault_secret_id - (Optional) The Secret ID of (base-64 encoded unencrypted pfx) the Secret or Certificate object stored in Azure KeyVault.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | <pre>map(object({<br> name = string<br> key_vault_secret_id = string<br> }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `null`  |    no    |
| <a name="input_ssl_profiles"></a> [ssl_profiles](#input_ssl_profiles)                                                       | (Optional) One or more ssl_profile blocks as defined below. Required if you want to use HTTPS on your listeners.<br><br> name - (Required) The name of the SSL Profile that is unique within this Application Gateway.<br> trusted_client_certificate_names - (Optional) The name of the Trusted Client Certificate that will be used to authenticate requests from clients.<br> verify_client_cert_issuer_dn - (Optional) Should client certificate issuer DN be verified? Defaults to false.<br> verify_client_certificate_revocation - (Optional) Specify the method to check client certificate revocation status. Possible value is OCSP.<br> ssl_policy - (Optional) One ssl_policy block as defined below.<br><br> A ssl_policy block supports the following:<br> cipher_suites - (Optional) A List of accepted cipher suites. Only supported when policy_type is set to Custom. For possible values refer to https://learn.microsoft.com/en-us/rest/api/application-gateway/application-gateways/create-or-update?view=rest-application-gateway-2024-01-01&tabs=HTTP#applicationgatewaysslciphersuite<br> min_protocol_version - (Optional) The minimal TLS version. Possible values are TLSv1_2 and TLSv1_3.<br><br> Note:                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | <pre>map(object({<br> name = string<br> trusted_client_certificate_names = optional(list(string), [])<br> verify_client_cert_issuer_dn = optional(bool, false)<br> verify_client_certificate_revocation = optional(string, null)<br> ssl_policy = object({<br> policy_type = optional(string, "Custom")<br> cipher_suites = optional(list(string), ["TLS_RSA_WITH_AES_128_CBC_SHA256"])<br> min_protocol_version = optional(string, "TLSv1_2")<br> })<br> }))</pre>                                                                                                                                                                                                                                                                                                                           | `{}`    |    no    |
| <a name="input_trusted_root_certificates"></a> [trusted_root_certificates](#input_trusted_root_certificates)                | (Required) One or more trusted_root_certificate blocks as defined below. Required if want End-to-End TLS encryption. Referenced in backend_http_settings:<br><br> name - (Required) The Name of the Trusted Root Certificate to use.<br> key_vault_secret_id - (Required) The Secret ID of (base-64 encoded unencrypted pfx) Secret or Certificate object stored in Azure KeyVault. You need to enable soft delete for the Key Vault to use this feature. Required if data is not set.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | <pre>map(object({<br> name = string<br> key_vault_secret_id = string<br> }))</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            | `null`  |    no    |
| <a name="input_url_path_maps"></a> [url_path_maps](#input_url_path_maps)                                                    | (Optional) One or more url_path_map blocks as defined below.<br><br> name - (Required) The Name of the URL Path Map.<br> default_backend_address_pool_name - (Optional) The Name of the Default Backend Address Pool which should be used for this URL Path Map. Cannot be set if default_redirect_configuration_name is set.<br> default_backend_http_settings_name - (Optional) The Name of the Default Backend HTTP Settings Collection which should be used for this URL Path Map. Cannot be set if default_redirect_configuration_name is set.<br> default_redirect_configuration_name - (Optional) The Name of the Default Redirect Configuration which should be used for this URL Path Map. Cannot be set if either default_backend_address_pool_name or default_backend_http_settings_name is set.<br> default_rewrite_rule_set_name - (Optional) The Name of the Default Rewrite Rule Set which should be used for this URL Path Map. Only valid for v2 SKUs.<br> path_rule - (Required) One or more path_rule blocks as defined below.<br><br> A path_rule block supports the following:<br><br> name - (Required) The Name of the Path Rule.<br> paths - (Required) A list of Paths used in this Path Rule.<br> backend_address_pool_name - (Optional) The Name of the Backend Address Pool to use for this Path Rule. Cannot be set if redirect_configuration_name is set.<br> backend_http_settings_name - (Optional) The Name of the Backend HTTP Settings Collection to use for this Path Rule. Cannot be set if redirect_configuration_name is set.<br> redirect_configuration_name - (Optional) The Name of a Redirect Configuration to use for this Path Rule. Cannot be set if backend_address_pool_name or backend_http_settings_name is set.<br> rewrite_rule_set_name - (Optional) The Name of the Rewrite Rule Set which should be used for this URL Path Map. Only valid for v2 SKUs.<br> firewall_policy_id - (Optional) The ID of the Web Application Firewall Policy which should be used as an HTTP Listener.<br><br> Note: Both default_backend_address_pool_name and default_backend_http_settings_name OR default_redirect_configuration_name should be specified.                                                                                                                                 | <pre>map(object({<br> name = string<br> default_backend_address_pool_name = optional(string, null)<br> default_backend_http_settings_name = optional(string, null)<br> default_redirect_configuration_name = optional(string, null)<br> default_rewrite_rule_set_name = optional(string, null)<br> path_rule = map(object({<br> name = string<br> paths = list(string)<br> backend_address_pool_name = optional(string, null)<br> backend_http_settings_name = optional(string, null)<br> redirect_configuration_name = optional(string, null)<br> rewrite_rule_set_name = optional(string, null)<br> }))<br> }))</pre>                                                                                                                                                                       | `{}`    |    no    |
| <a name="input_user_assigned_managed_identity"></a> [user_assigned_managed_identity](#input_user_assigned_managed_identity) | (Optional) One user assigned managed identity block is defined below. Required when configuring https for a listener or TBD. Setting this creates a managed identity with Key Vault Certificate User role on the designated Key Vault.<br><br> name - (Required) The name of the user assigned managed identity.<br> key_vault_id - (Required) The resource ID of the key vault.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | <pre>object({<br> name = string<br> key_vault_id = string<br> })</pre>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | `null`  |    no    |

# Examples

<a id="Examples"></a>

These examples are here to demonstrate various usages of the Application Gateway module.

## Example -- Simple Redirect

<a id="Example_--_Simple_Redirect"></a>

This example demonstrates the minimum requirements for provisioning the Application Gateway with a simple redirection. No backends are configured. A simple redirection page is configured to a `http` website `httpbin.org`. This can be helpful if you want to simply provision the Application Gateway and then clickops settings in later.

To provision this example:

1. Ensure that `resource_group_name` is a valid resource group.
1. Ensure that `app_gateway_subnet_id` is the id of a valid subnet (reccomended size `/24` for ease).

```hcl
// Environment dependency: app_gateway_subnet had CIDR range 10.0.0.0/24
locals {
  resource_group_name     = "arg-application-gateway"
  resource_group_location = "australiaeast"
  app_gateway_subnet_id   = "/subscriptions/XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX/resourceGroups/nrg-networks/providers/Microsoft.Network/virtualNetworks/shared-vnet/subnets/app-gateway-subnet"
}

locals {
  public_ip_configuration = {
    public_ip_name              = "app-gateway-pip"
    frontend_configuration_name = "frontend-public"
    domain_name_label           = "mason-app-gateway"
  }

  frontend_ports = {
    port_80 = {
      name = "frontend-port"
      port = 80
    }
  }

  http_listeners = {
    default_http_listener = {
      name                        = "default-http-listener"
      frontend_configuration_name = local.public_ip_configuration.frontend_configuration_name
      frontend_port_name          = local.frontend_ports.port_80.name
      protocol                    = "Http"
    }
  }

  backend_http_settings = {
    default_backend_http_settings = {
      name                  = "default-backend-http-settings"
      cookie_based_affinity = "Disabled"
      port                  = 80
      protocol              = "Http"
    }
  }

  backend_address_pools = {
    default_backend_address_pool = {
      name = "default-backend-pool"
    }
  }

  redirect_configurations = {
    redirect_to_http_bin = {
      name          = "redirect-to-httpbin"
      redirect_type = "Temporary"
      target_url    = "http://httpbin.org"
    }
  }

  request_routing_rules = {
    default_request_routing_rule = {
      name                        = "default-request-routing-rule"
      http_listener_name          = local.http_listeners.default_http_listener.name
      rule_type                   = "Basic"
      priority                    = 101
      redirect_configuration_name = local.redirect_configurations.redirect_to_http_bin.name
    }
  }
}

// Note: the backend_http_settings and backend_address_pools are required for provisioning but do not do anything in this example.
module "example_app_gateway" {
  source                  = "./terraform-application-gateway"
  name                    = "test-app-gateway"
  resource_group_name     = local.resource_group_name
  location                = local.resource_group_location
  subnet_id               = local.app_gateway_subnet_id
  sku_capacity            = 1
  public_ip_configuration = local.public_ip_configuration
  frontend_ports          = local.frontend_ports
  http_listeners          = local.http_listeners
  backend_http_settings   = local.backend_http_settings
  backend_address_pools   = local.backend_address_pools
  request_routing_rules   = local.request_routing_rules
  redirect_configurations = local.redirect_configurations
}
```

to see more examples refer to the [examples folder](./examples).

# Outputs

<a id="Outputs"></a>

| Name                                      | Description                        |
| ----------------------------------------- | ---------------------------------- |
| <a name="output_id"></a> [id](#output_id) | The ID of the Application Gateway. |

# Appendix

<a id="Appendix"></a>

This module was created with the help of `terraform-docs`. To automate the creation of the module run:

- `terraform-docs -c terraform-docs.yaml .`
- `./create-table-of-contents.sh "README.md"`
<!-- END_TF_DOCS -->
